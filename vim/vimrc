set nocompatible
filetype plugin indent on

" Pathogen
execute pathogen#infect()

" GUI specific stuff
if has("gui_running")

  if has('win32')
    "add windows key behaviors for windows gui
    source $VIMRUNTIME/mswin.vim
  endif

  set guioptions-=T " hide toolbar in gui
  set guioptions+=b " show bottom scroll bar

  " set window size
  set lines=36
  set columns=120
endif

" General
set autoread          " reload files when changed on disk, i.e. via `git checkout`
set history=1000      " remember commands
set tabpagemax=50     " maximum number of tab pages
set nrformats-=octal  " remove octal from <C-A> incrementing

set encoding=utf-8    " set file encoding
set fileformats+=mac  " default to mac EOLs

set laststatus=2      " always show status bar
set noshowmode        " use airline to show the mode
set showmatch         " show matching brackets
set showcmd           " show incomplete commands
set wildmenu          " show command line completion

set backspace=indent,eol,start  " ???
set complete-=i                 " ???

" wait 50ms for keycodes
set ttimeout
set ttimeoutlen=50

" no backup
set nobackup
set nowritebackup
set noswapfile

" Indenting
set tabstop=2     " tab is 2 spaces
set shiftwidth=2  " auto-indent and >,< use 2 spaces
set shiftround    " always round >,< tabs to shiftwidth location
set expandtab     " expand tabs to spaces
set autoindent    " automatically do indenting
set smarttab      " <BS> will delete shiftwidth worth of space at start of line

" Folding
" set foldenable
" set foldmethod=syntax
" set foldcolumn=5
" set foldlevel=5

" Theme
syntax enable             " enable syntax highlighting
set number                " show line numbers
set nowrap                " don't wrap overflow text
set background=dark       " background is dark
let g:solarized_italic=0  " solarized italics don't look good
colorscheme solarized     " use solarized colors
call togglebg#map("<F9>") " Toggle light/dark colors with <leader>s

" open new split panes to right and bottom
set splitbelow
set splitright

" always show some margin space
set scrolloff=1       " always show a line above and below the cursor
set sidescrolloff=5   " always show 5 colums to the right of the cursor
set display+=lastline " ???

" Highlight searching
set hlsearch    " highlight searches
set incsearch   " show matches as search is being typed
" ctrl-N unhighlights
nnoremap <silent> <C-N> :nohlsearch<CR><C-N>

" Keyboard shortcuts
let mapleader = ','

" map easier window movement
map <C-h> <C-w>h
map <C-j> <C-w>j
map <C-k> <C-w>k
map <C-l> <C-w>l

" align text blocks on a symbol
" map <leader>l :Align
nmap <Leader>a= :Tabularize /=<CR>
vmap <Leader>a= :Tabularize /=<CR>
nmap <Leader>a: :Tabularize /:\zs<CR>
vmap <Leader>a: :Tabularize /:\zs<CR>

" grep replacement
nmap <leader>a :Ack
" toggle file browser
nmap <leader>d :NERDTreeToggle<CR>
" find current file in file browser
nmap <leader>f :NERDTreeFind<CR>
" fuzzy file searching
nmap <leader>t :CtrlP<CR>
" fuzzy file searching in current buffers
nmap <leader>b :CtrlPBuffer<CR>
" clear fuzzy file searching cache
nmap <leader>T :CtrlPClearCache<CR>:CtrlP<CR>
" toggle ctag browser
nmap <leader>] :TagbarToggle<CR>
" toggle git diff markers in gutter
nmap <leader>g :GitGutterToggle<CR>

" rails naviagion
nmap <leader>v :Eview<CR>
nmap <leader>c :Econtroller<CR>
nmap <leader>m :Emodel<CR>

" set vimrc path appropriately, and set command to reload vimrc
if has('win32')
  map <silent> <leader>V :source ~/_vimrc<CR>:filetype detect<CR>:exe ":echo 'vimrc reloaded'"<CR>
else
  map <silent> <leader>V :source ~/.vimrc<CR>:filetype detect<CR>:exe ":echo 'vimrc reloaded'"<CR>
endif
" nmap <leader><space> :call whitespace#strip_trailing()<CR>

" Plugin settings
let g:ctrlp_match_window = 'order:ttb,max:20'      " ???
let g:NERDSpaceDelims=1                            " ???
let g:gitgutter_enabled=0                          " git gutter disabled by default
let g:syntastic_check_on_open=1                    " use syntastic to check file on open
let g:syntastic_ruby_checkers = ['rubocop'] " use rubocop and default for ruby
let g:airline_powerline_fonts = 1
" set airline's second section to git branch, doesn't work by default on win
if has('win32')
  let g:airline_section_b = '%{fugitive#head()}'
endif

" use silver searcher, when available
if executable('ag')
  let g:ackprg = 'ag --nogroup --column'

  " use Ag over Grep
  set grepprg=ag\ --nogroup\ --nocolor

  " use ag in CtrlP for listing files. Lightning fast and respects .gitignore
  let g:ctrlp_user_command = 'ag %s -l --nocolor -g ""'
endif

" Autocommands
autocmd VimResized * :wincmd =      " automatically rebalance windows on vim resize
autocmd BufWritePre * :%s/\s\+$//e  " Cleanup trailing whitespace on save

" add filetype mappings
autocmd BufRead,BufNewFile *.fdoc set filetype=yaml   " fdoc is yaml
autocmd BufRead,BufNewFile *.md set filetype=markdown " md is markdown

" extra rails.vim help
autocmd User Rails silent! Rnavcommand decorator      app/decorators            -glob=**/* -suffix=_decorator.rb
autocmd User Rails silent! Rnavcommand observer       app/observers             -glob=**/* -suffix=_observer.rb
autocmd User Rails silent! Rnavcommand feature        features                  -glob=**/* -suffix=.feature
autocmd User Rails silent! Rnavcommand job            app/jobs                  -glob=**/* -suffix=_job.rb
autocmd User Rails silent! Rnavcommand mediator       app/mediators             -glob=**/* -suffix=_mediator.rb
autocmd User Rails silent! Rnavcommand stepdefinition features/step_definitions -glob=**/* -suffix=_steps.rb

" Extra

" don't use rvm on windows
if !has('win32')
  autocmd BufEnter * Rvm
endif

" List chars
if &listchars ==# 'eol:$'
  set listchars=tab:>\ ,trail:-,extends:>,precedes:<,nbsp:+
  if !has('win32') && (&termencoding ==# 'utf-8' || &encoding ==# 'utf-8')
    let &listchars = "tab:\u21e5 ,trail:\u2423,extends:\u21c9,precedes:\u21c7,nbsp:\u00b7"
  endif
endif

" allow color schemes to do bright colors without forcing bold.
if &t_Co == 8 && $TERM !~# '^linux'
  set t_Co=16
endif

" make Y consistent with C and D
nnoremap Y y$

" enable mouse interaction
set mouse=a

" repmap C-a as tmux steals it
nnoremap <C-q> <C-a>

" paste from clipboard
vmap <leader>y "+y
nmap <leader>p "+p

" rspec / tslime
let g:rspec_command = 'call Send_to_Tmux("rspec {spec}\n")'
map <leader>R :call RunAllSpecs()<CR>
map <leader>r :call RunCurrentSpecFile()<CR>
map <leader>s :call RunNearestSpec()<CR>
" nmap <leader>b <Plug>SetTmuxVars

" cucumber bar/pipe align
inoremap <silent> <Bar>   <Bar><Esc>:call <SID>align()<CR>a

function! s:align()
  let p = '^\s*|\s.*\s|\s*$'
  if exists(':Tabularize') && getline('.') =~# '^\s*|' && (getline(line('.')-1) =~# p || getline(line('.')+1) =~# p)
    let column = strlen(substitute(getline('.')[0:col('.')],'[^|]','','g'))
    let position = strlen(matchstr(getline('.')[0:col('.')],'.*|\s*\zs.*'))
    Tabularize/|/l1
    normal! 0
    call search(repeat('[^|]*|',column).'\s\{-\}'.repeat('.',position),'ce',line('.'))
  endif
endfunction
